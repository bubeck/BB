#USE_GRID
#DROP_POINTS

#rename layers
rename-layers polygons,lines,grid

#clean geometry
clean snap-interval=0.00001 target=polygons
clean snap-interval=0.00001 target=lines

#disolve
dissolve target=lines
dissolve2 target=polygons

#remove small islands
filter-slivers min-area=5000sqm target=polygons

#simplify geometry
simplify 20% target=polygons
simplify 20% target=lines

#remove rivers from water polygons
erase source=polygons target=lines

#clip excess geometry 
clip bbox=%lon1%,%lat1%,%lon2%,%lat2% target=polygons
clip bbox=%lon1%,%lat1%,%lon2%,%lat2% target=lines

#slice
slice grid target=polygons
merge-layers target=slice-* name=polygons
explode name=polygons

slice grid target=lines
merge-layers target=slice-* name=lines
explode name=lines

#tag features
each 'this.properties = {type:"water", "sliced": true}' target=polygons
each 'this.properties = {type:"river", "sliced": true}' target=lines

